#!/usr/bin/env bash
set -euo pipefail

if [ $# -lt 1 ]; then
    adb shell screenrecord --help
    exit 1
fi

outfile="${@:$(($#))}"
outext="${outfile##*.}"
outext="${outext:-mp4}"
outbase="${outfile%%.*}"

set -- "${@:1:$(($# - 1))}"

i=0
while true; do
    outpart="$outbase-$((i++)).$outext"
    adb exec-out screenrecord "$@" --output-format=h264 - | ffmpeg -i - -c:v copy -f mp4 "$outpart"
done
